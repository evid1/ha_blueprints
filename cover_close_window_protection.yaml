blueprint:
  name: Rollo-Steuerung (Smarte Fensteröffnung) - (v4 fix)
  description: >
    Schließt das Rollo X Minuten nach Sonnenuntergang/Dämmerung.
    Berücksichtigt den Fensterstatus und öffnet optional beim Öffnen.
  domain: automation
  input:
    target_cover:
      name: Rollo (Cover)
      selector:
        entity:
          domain: cover
    window_sensor:
      name: Fenster- oder Türsensor
      selector:
        entity:
          domain: binary_sensor
          device_class: [window, door]
    sunset_offset_mins:
      name: Verzögerung nach Dämmerung (Minuten)
      default: 30
      selector:
        number:
          min: 0
          max: 300
          unit_of_measurement: min
          mode: box
    enable_auto_open:
      name: Automatisch öffnen bei Öffnung
      default: false
      selector:
        boolean: {}
    open_position_pct:
      name: Öffnungsgrad bei Öffnung
      default: 100
      selector:
        number:
          min: 0
          max: 100
          unit_of_measurement: "%"
          mode: slider

mode: restart

variables:
  # Konvertiere Inputs in Variablen für Templates
  offset_mins: !input sunset_offset_mins
  open_pos: !input open_position_pct

trigger:
  # Auslöser 1: Zeit-Trigger basierend auf Sensor + Offset via Template
  - platform: template
    value_template: >
      {% set dusk = states('sensor.sun_next_dusk') | as_datetime %}
      {{ now() >= dusk + timedelta(minutes=offset_mins | int) }}
    id: "zeit_event"
  
  # Auslöser 2: Fenster wird geschlossen
  - platform: state
    entity_id: !input window_sensor
    from: "on"
    to: "off"
    id: "sensor_wurde_zu"
  
  # Auslöser 3: Fenster wird geöffnet
  - platform: state
    entity_id: !input window_sensor
    from: "off"
    to: "on"
    id: "sensor_wurde_auf"

action:
  - choose:
      # FALL 1: FENSTER WIRD GEÖFFNET (Nur wenn es dunkel ist)
      - conditions:
          - condition: trigger
            id: "sensor_wurde_auf"
          - condition: template
            value_template: !input enable_auto_open
          - condition: state
            entity_id: sun.sun
            state: "below_horizon"
        sequence:
          - service: cover.set_cover_position
            target:
              entity_id: !input target_cover
            data:
              position: "{{ open_pos }}"

      # FALL 2: ZEITPUNKT ERREICHT ODER FENSTER NACHTRÄGLICH GESCHLOSSEN
      - conditions:
          - or:
              - condition: trigger
                id: "zeit_event"
              - condition: trigger
                id: "sensor_wurde_zu"
          # Bedingung: Es muss nach der Dämmerung (+ Offset) sein
          - condition: template
            value_template: >
              {% set dusk = states('sensor.sun_next_dusk') | as_datetime %}
              {{ now() >= dusk + timedelta(minutes=offset_mins | int) }}
          # Bedingung: Fenster muss zu sein
          - condition: state
            entity_id: !input window_sensor
            state: "off"
        sequence:
          - service: cover.close_cover
            target:
              entity_id: !input target_cover